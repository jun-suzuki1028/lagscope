# CI/CD テスト安定性ガイド

## 概要
このドキュメントはLagScopeプロジェクトのCI/CDパイプラインの安定性を確保するためのガイドラインです。

## CI失敗の主要原因と対策

### 1. UI変更によるテスト失敗
**原因**: UIコンポーネントの構造変更時にテストの期待値が古いままになる

**対策**:
- テスト作成時にデータ属性（`data-testid`）を使用
- UI実装とテストを同時に更新
- 統合テストでは実際のユーザーフローをテスト

**例**:
```tsx
// 良い例: data-testidを使用
<button data-testid="character-select-modal">キャラクター選択</button>
screen.getByTestId('character-select-modal')

// 悪い例: 具体的なテキストに依存
screen.getByText('キャラクター選択モーダルを開く')
```

### 2. 状態管理（Zustand）の変更
**原因**: ストア構造の変更時にモックが更新されない

**対策**:
- ストア変更時は全関連テストファイルを確認
- 型安全なモック作成
- 共通モックファイルの活用

### 3. 非同期処理のタイミング問題
**原因**: モーダル表示、API呼び出し等の非同期処理の完了を待たない

**対策**:
- `findBy*` クエリで要素の出現を待機
- `waitFor` を使用してアサーション前に待機
- `act()` でReact状態更新を適切にラップ

## テスト品質チェックリスト

### 単体テスト
- [ ] コンポーネントの主要な動作をテスト
- [ ] エラー状態とローディング状態をテスト
- [ ] プロパティの変更に対する反応をテスト

### 統合テスト
- [ ] 実際のユーザーフローをシミュレート
- [ ] モーダル開閉、検索、選択の一連の流れをテスト
- [ ] 複数コンポーネント間の連携をテスト

### E2Eテスト
- [ ] 主要機能の完全なユーザージャーニーをテスト
- [ ] レスポンシブ動作をテスト
- [ ] パフォーマンスの基本チェック

## メンテナンス手順

### UI変更時
1. 影響するテストファイルを特定
2. テストの期待値を新UIに合わせて更新
3. ローカルでテスト実行確認
4. CI実行前にコミット

### ストア構造変更時
1. 型定義の変更を確認
2. モックオブジェクトを更新
3. 関連する全テストファイルを確認
4. 新しい状態管理ロジックのテストを追加

### 新機能追加時
1. 機能仕様に基づいてテストケース設計
2. TDD（テスト駆動開発）の採用を推奨
3. エッジケースも含めた包括的テスト
4. テストカバレッジの確認

## CI失敗時の対応手順

1. **エラーログの確認**
   ```bash
   gh run view [run-id] --log-failed
   ```

2. **ローカル再現**
   ```bash
   npm run test:run
   npm run lint
   npx tsc --noEmit
   ```

3. **修正とテスト**
   - エラーの根本原因を特定
   - 修正実装
   - ローカルで全テスト実行

4. **予防策の実装**
   - 同様の問題の再発防止策を検討
   - ドキュメント更新

## 推奨ツールと設定

### テスト実行順序
```bash
# 開発時の推奨順序
npm run lint          # コーディング規約
npx tsc --noEmit     # 型チェック
npm run test:run     # 単体・統合テスト
npx playwright test  # E2Eテスト
npm run build        # ビルド確認
```

### VSCode設定推奨
```json
{
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.preferences.includePackageJsonAutoImports": "off"
}
```

## 継続的改善

- 月次でCI失敗率の分析
- テスト実行時間の監視と最適化
- 新しいテスト技法の導入検討
- チーム内でのベストプラクティス共有